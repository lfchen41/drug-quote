<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Drug Quotation System</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body class="bg-gray-100 min-h-screen">
  <!-- Header -->
  <header class="bg-red-800 text-white shadow-lg">
    <div class="max-w-7xl mx-auto px-4 py-3">
      <div class="flex justify-between items-center">
        <h1 class="text-2xl font-bold">Drug Quotation System</h1>
        <div id="userInfo" class="text-sm" style="display:none">
          <span id="userEmail"></span>
          <button onclick="signOut()" class="ml-4 bg-red-600 text-white px-3 py-1 rounded text-sm hover:bg-red-700">Sign Out</button>
        </div>
      </div>
    </div>
  </header>

  <!-- Auth Section -->
  <div id="authSection" class="max-w-md mx-auto mt-20 bg-white p-6 rounded-lg shadow-lg">
    <h2 class="text-xl font-semibold mb-4 text-center">Sign In</h2>
    <div class="space-y-3">
      <input id="email" type="email" placeholder="Email" class="border p-3 rounded w-full">
      <input id="password" type="password" placeholder="Password" class="border p-3 rounded w-full">
      <button onclick="signIn()" class="bg-blue-600 text-white px-4 py-2 rounded w-full hover:bg-blue-700">Sign In</button>
    </div>
    <div id="authStatus" class="mt-3 text-sm text-red-600 text-center"></div>
  </div>

  <!-- Main App -->
  <div id="appSection" style="display:none">
    <!-- Navigation Menu -->
    <nav class="bg-white shadow-md">
      <div class="max-w-7xl mx-auto px-4">
        <div class="flex space-x-8">
          <button onclick="showPage('quotation')" class="nav-btn py-4 px-2 border-b-2 border-transparent hover:border-blue-500 font-medium text-gray-700 hover:text-blue-600">
            Generate Quotation
          </button>
          <button onclick="showPage('history')" class="nav-btn py-4 px-2 border-b-2 border-transparent hover:border-blue-500 font-medium text-gray-700 hover:text-blue-600">
            Quotation History
          </button>
          <button onclick="showPage('products')" class="nav-btn py-4 px-2 border-b-2 border-transparent hover:border-blue-500 font-medium text-gray-700 hover:text-blue-600">
            Products
          </button>
          <button onclick="showPage('customers')" class="nav-btn py-4 px-2 border-b-2 border-transparent hover:border-blue-500 font-medium text-gray-700 hover:text-blue-600">
            Customers
          </button>
        </div>
      </div>
    </nav>

    <!-- Content Area -->
    <main class="max-w-7xl mx-auto px-4 py-6">
      
      <!-- Generate Quotation Page -->
      <div id="quotationPage" class="page-content">
        <div class="bg-white rounded-lg shadow p-6">
          <h2 class="text-2xl font-bold mb-6 text-gray-800">Generate Quotation</h2>
          
          <!-- Customer Selection -->
          <div class="mb-6 p-4 bg-blue-50 rounded-lg">
            <h3 class="text-lg font-semibold mb-3">Customer Information</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <select id="customerSelect" class="border p-2 rounded w-full">
                <option value="">Select Customer</option>
              </select>
              <input id="quotationDate" type="date" class="border p-2 rounded w-full">
            </div>
          </div>

          <!-- Product Selection -->
          <div class="mb-6 p-4 bg-green-50 rounded-lg">
            <h3 class="text-lg font-semibold mb-3">Add Products</h3>
            <div class="grid grid-cols-1 md:grid-cols-6 gap-3">
              <div class="relative">
                <input id="productAutocomplete" type="text" class="border p-2 rounded w-full" placeholder="Type to search product..." autocomplete="off">
                <div id="productAutocompleteList" class="absolute z-10 bg-white border w-full rounded shadow max-h-48 overflow-y-auto" style="display:none;"></div>
              </div>
              <input id="quantity" type="number" placeholder="Quantity" class="border p-2 rounded w-full" min="1" value="1">
              <input id="markupInput" type="number" placeholder="Markup %" class="border p-2 rounded w-full" min="0" step="0.1">
              <input id="itemPrice" type="number" placeholder="Price" class="border p-2 rounded w-full" min="0" step="0.01" value="0">
              <button onclick="addToQuotation()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">Add to Quotation</button>
            </div>
            <div id="selectedProductInfo" class="mt-3 p-3 bg-white rounded border" style="display:none;">
              <div class="grid grid-cols-1 md:grid-cols-6 gap-2 text-sm">
                <div><strong>Description:</strong> <span id="infoDescription"></span></div>
                <div><strong>Manufacturer:</strong> <span id="infoManufacturer"></span></div>
                <div><strong>Form:</strong> <span id="infoForm"></span></div>
                <div><strong>Strength:</strong> <span id="infoStrength"></span></div>
                <div><strong>Size:</strong> <span id="infoSize"></span></div>
                <div><strong>Cost:</strong> <span id="infoCost"></span></div>
              </div>
              <div class="mt-2 text-xs text-gray-500">
                Enter markup % or price. If both are entered, price will be used. Price cannot be below cost.
              </div>
            </div>
          </div>

          <!-- Quotation Items -->
          <div class="mb-6">
            <h3 class="text-lg font-semibold mb-3">Quotation Items</h3>
            <div id="quotationItems" class="space-y-2"></div>
            <div class="mt-4 p-4 bg-gray-50 rounded">
              <div class="text-right">
                <span class="text-xl font-bold text-blue-600">Total: $<span id="quotationTotal">0.00</span></span>
              </div>
            </div>
          </div>

          <!-- Actions -->
          <div class="flex space-x-4">
            <button onclick="saveQuotation()" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700">Save Quotation</button>
            <button onclick="clearQuotation()" class="bg-gray-500 text-white px-6 py-2 rounded hover:bg-gray-600">Clear</button>
            <button onclick="copyQuotationToClipboard()" class="bg-purple-600 text-white px-6 py-2 rounded hover:bg-purple-700">Copy to Clipboard</button>
          </div>
        </div>
      </div>

      <!-- Quotation History Page -->
      <div id="historyPage" class="page-content" style="display:none">
        <div class="bg-white rounded-lg shadow p-6">
          <h2 class="text-2xl font-bold mb-6 text-gray-800">Quotation History</h2>
          
          <!-- Search and Filter -->
          <div class="mb-6 p-4 bg-gray-50 rounded-lg">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <input id="historySearch" placeholder="Search by customer or quotation number..." class="border p-2 rounded w-full">
              <select id="historyDateFilter" class="border p-2 rounded w-full">
                <option value="">All Dates</option>
                <option value="today">Today</option>
                <option value="week">This Week</option>
                <option value="month">This Month</option>
              </select>
              <button onclick="loadQuotationHistory()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Refresh</button>
            </div>
          </div>

          <!-- History List -->
          <div id="historyList" class="space-y-4"></div>
        </div>
      </div>

      <!-- Products Page -->
      <div id="productsPage" class="page-content" style="display:none">
        <div class="bg-white rounded-lg shadow p-6">
          <h2 class="text-2xl font-bold mb-6 text-gray-800">Products Management</h2>
          
          <!-- Add Product Form -->
          <div class="mb-6 p-4 bg-blue-50 rounded-lg">
            <h3 class="text-lg font-semibold mb-3">Add New Product</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
              <input id="din" class="border p-2 rounded w-full" placeholder="DIN">
              <input id="productDescription" class="border p-2 rounded w-full" placeholder="Product Description">
              <input id="manufacturer" class="border p-2 rounded w-full" placeholder="Manufacturer">
              <input id="form" class="border p-2 rounded w-full" placeholder="Form">
              <input id="strength" class="border p-2 rounded w-full" placeholder="Strength">
              <input id="size" class="border p-2 rounded w-full" placeholder="Size">
              <input id="cost" class="border p-2 rounded w-full" placeholder="Cost" type="number" step="0.01">
              <select id="currency" class="border p-2 rounded w-full">
                <option value="USD">USD</option>
                <option value="CAD">CAD</option>
                <option value="EUR">EUR</option>
              </select>
              <input id="spcMonograph" class="border p-2 rounded w-full" placeholder="SPC/Monograph">
            </div>
            <div class="mt-3">
              <button onclick="addProduct()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Add Product</button>
            </div>
          </div>

          <!-- Bulk Upload Section -->
          <div class="mb-6 p-4 bg-green-50 rounded-lg">
            <h3 class="text-lg font-semibold mb-3">Bulk Upload Products</h3>
            <div class="mb-3">
              <input type="file" id="fileInput" accept=".csv,.xlsx,.xls" class="border p-2 rounded w-full bg-white">
              <button onclick="uploadFile()" class="bg-green-600 text-white px-4 py-2 rounded mt-2 hover:bg-green-700">Upload File</button>
            </div>
            <div class="text-sm text-gray-600">
              <p><strong>Expected columns:</strong> DIN, Product Description, Manufacturer, Form, Strength, Size, Cost, Currency, SPC/Monograph</p>
            </div>
          </div>

          <!-- Search Section -->
          <div class="mb-6 p-4 bg-yellow-50 rounded-lg">
            <h3 class="text-lg font-semibold mb-3">Search Products</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
              <input id="searchInput" class="border p-2 rounded w-full" placeholder="Search by DIN, description, manufacturer...">
              <select id="sortBy" class="border p-2 rounded w-full">
                <option value="">Sort by...</option>
                <option value="din">DIN</option>
                <option value="productDescription">Product Description</option>
                <option value="manufacturer">Manufacturer</option>
                <option value="cost">Cost</option>
              </select>
              <select id="filterCurrency" class="border p-2 rounded w-full">
                <option value="">All Currencies</option>
                <option value="USD">USD</option>
                <option value="CAD">CAD</option>
                <option value="EUR">EUR</option>
              </select>
            </div>
            <div class="mt-3">
              <button onclick="clearSearch()" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">Clear Search</button>
              <button onclick="exportToCSV()" class="bg-purple-600 text-white px-4 py-2 rounded ml-2 hover:bg-purple-700">Export to CSV</button>
            </div>
          </div>

          <!-- Products List -->
          <div class="mb-4">
            <h3 class="text-lg font-semibold mb-3">Products (<span id="productCount">0</span>)</h3>
            <div id="productList" class="space-y-2"></div>
          </div>
        </div>
      </div>

      <!-- Customers Page -->
      <div id="customersPage" class="page-content" style="display:none">
        <div class="bg-white rounded-lg shadow p-6">
          <h2 class="text-2xl font-bold mb-6 text-gray-800">Customers Management</h2>
          
          <!-- Add Customer Form -->
          <div class="mb-6 p-4 bg-blue-50 rounded-lg">
            <h3 class="text-lg font-semibold mb-3">Add New Customer</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
              <input id="customerName" class="border p-2 rounded w-full" placeholder="Customer Name">
              <input id="contactPerson" class="border p-2 rounded w-full" placeholder="Contact Person">
              <input id="customerEmail" class="border p-2 rounded w-full" placeholder="Email">
              <input id="phone" class="border p-2 rounded w-full" placeholder="Phone">
              <textarea id="address" class="border p-2 rounded w-full col-span-2" placeholder="Address" rows="3"></textarea>
            </div>
            <div class="mt-3">
              <button onclick="addCustomer()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Add Customer</button>
            </div>
          </div>

          <!-- Search Customers -->
          <div class="mb-6 p-4 bg-yellow-50 rounded-lg">
            <h3 class="text-lg font-semibold mb-3">Search Customers</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
              <input id="customerSearch" class="border p-2 rounded w-full" placeholder="Search by name, email, or phone...">
              <button onclick="clearCustomerSearch()" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">Clear Search</button>
            </div>
          </div>

          <!-- Customers List -->
          <div class="mb-4">
            <h3 class="text-lg font-semibold mb-3">Customers (<span id="customerCount">0</span>)</h3>
            <div id="customerList" class="space-y-2"></div>
          </div>
        </div>
      </div>

    </main>
  </div>

  <!-- Edit Product Modal -->
  <div id="editProductModal" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-30 z-50" style="display:none;">
    <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-lg relative">
      <button id="closeEditProductModal" class="absolute top-2 right-2 text-gray-500 hover:text-gray-800">&times;</button>
      <h3 class="text-lg font-semibold mb-4">Edit Product</h3>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <input id="edit_din" class="border p-2 rounded w-full" placeholder="DIN">
        <input id="edit_productDescription" class="border p-2 rounded w-full" placeholder="Product Description">
        <input id="edit_manufacturer" class="border p-2 rounded w-full" placeholder="Manufacturer">
        <input id="edit_form" class="border p-2 rounded w-full" placeholder="Form">
        <input id="edit_strength" class="border p-2 rounded w-full" placeholder="Strength">
        <input id="edit_size" class="border p-2 rounded w-full" placeholder="Size">
        <input id="edit_cost" class="border p-2 rounded w-full" placeholder="Cost" type="number" step="0.01">
        <select id="edit_currency" class="border p-2 rounded w-full">
          <option value="USD">USD</option>
          <option value="CAD">CAD</option>
          <option value="EUR">EUR</option>
        </select>
        <input id="edit_spcMonograph" class="border p-2 rounded w-full" placeholder="SPC/Monograph">
      </div>
      <div class="mt-4 flex justify-end">
        <button id="saveEditProductBtn" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Save</button>
      </div>
    </div>
  </div>

  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyAlEHrWqdDlyTd6MIgJxImw2CUcvCgv2io",
      authDomain: "drug-quote-app.firebaseapp.com",
      projectId: "drug-quote-app",
      storageBucket: "drug-quote-app.appspot.com",
      messagingSenderId: "53239915592",
      appId: "1:53239915592:web:d9d98e1ef13dadf307a47d"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const UID_ALLOWED = "8rxZVxHrfbT1bmAYXu083h775ND2";

    // Global variables
    let currentUser = null;
    let products = [];
    let customers = [];
    let quotations = [];
    let currentQuotation = [];
    let currentPage = 'quotation';

    // Authentication state observer
    auth.onAuthStateChanged((user) => {
      if (user && user.uid === UID_ALLOWED) {
        currentUser = user;
        document.getElementById('authSection').style.display = 'none';
        document.getElementById('appSection').style.display = 'block';
        document.getElementById('userEmail').textContent = user.email;
        document.getElementById('userInfo').style.display = 'block';
        initializeApp();
      } else {
        currentUser = null;
        document.getElementById('authSection').style.display = 'block';
        document.getElementById('appSection').style.display = 'none';
        document.getElementById('userInfo').style.display = 'none';
        if (user && user.uid !== UID_ALLOWED) {
          alert('Access denied. You are not authorized to use this application.');
          signOut();
        }
      }
    });

    // Initialize app data
    function initializeApp() {
      loadProducts();
      loadCustomers();
      loadQuotationHistory();
      showPage('quotation');
      // Set default date
      const todayStr = new Date().toISOString().slice(0, 10);
      document.getElementById('quotationDate').value = todayStr;
      setupMarkupPriceBinding();
      setupProductAutocomplete();
    }

    // Page navigation
    function showPage(pageId) {
      // Hide all pages
      document.querySelectorAll('.page-content').forEach(page => {
        page.style.display = 'none';
      });
      
      // Remove active class from all nav buttons
      document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.classList.remove('border-blue-500', 'text-blue-600');
        btn.classList.add('border-transparent', 'text-gray-700');
      });
      
      // Show selected page
      document.getElementById(pageId + 'Page').style.display = 'block';
      
      // Add active class to current nav button
      event.target.classList.remove('border-transparent', 'text-gray-700');
      event.target.classList.add('border-blue-500', 'text-blue-600');
      
      currentPage = pageId;
    }

    // Authentication functions
    function signIn() {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      
      if (!email || !password) {
        document.getElementById('authStatus').textContent = 'Please enter both email and password';
        return;
      }

      auth.signInWithEmailAndPassword(email, password)
        .then((userCredential) => {
          if (userCredential.user.uid !== UID_ALLOWED) {
            document.getElementById('authStatus').textContent = 'Access denied. You are not authorized to use this application.';
            signOut();
          }
        })
        .catch((error) => {
          document.getElementById('authStatus').textContent = 'Sign in failed: ' + error.message;
        });
    }

    function signOut() {
      auth.signOut().then(() => {
        products = [];
        customers = [];
        quotations = [];
        currentQuotation = [];
        document.getElementById('email').value = '';
        document.getElementById('password').value = '';
        document.getElementById('authStatus').textContent = '';
      });
    }

    // Product management functions
    function addProduct() {
      if (!currentUser) return;

      const din = document.getElementById('din').value;
      const productDescription = document.getElementById('productDescription').value;
      const manufacturer = document.getElementById('manufacturer').value;
      const form = document.getElementById('form').value;
      const strength = document.getElementById('strength').value;
      const size = document.getElementById('size').value;
      const cost = document.getElementById('cost').value;
      const currency = document.getElementById('currency').value;
      const spcMonograph = document.getElementById('spcMonograph').value;

      if (!din || !productDescription || !manufacturer || !form || !strength || !size || !cost || !currency) {
        alert('Please fill in all required fields');
        return;
      }

      const product = {
        din, productDescription, manufacturer, form, strength, size,
        cost: parseFloat(cost), currency, spcMonograph,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      };

      db.collection('products').add(product)
        .then(() => {
          clearProductForm();
          loadProducts();
          alert('Product added successfully!');
        })
        .catch((error) => {
          alert('Error adding product: ' + error.message);
        });
    }

    function clearProductForm() {
      ['din', 'productDescription', 'manufacturer', 'form', 'strength', 'size', 'cost', 'spcMonograph'].forEach(id => {
        document.getElementById(id).value = '';
      });
      document.getElementById('currency').value = 'USD';
    }

    function loadProducts() {
      if (!currentUser) return;

      db.collection('products').orderBy('createdAt', 'desc').get()
        .then((querySnapshot) => {
          products = [];
          querySnapshot.forEach((doc) => {
            products.push({ id: doc.id, ...doc.data() });
          });
          displayProducts();
          updateProductSelect();
          setupProductAutocomplete();
        })
        .catch((error) => {
          alert('Error loading products: ' + error.message);
        });
    }

    function displayProducts() {
      const productList = document.getElementById('productList');
      const searchTerm = document.getElementById('searchInput')?.value.toLowerCase() || '';
      const sortBy = document.getElementById('sortBy')?.value || '';
      const filterCurrency = document.getElementById('filterCurrency')?.value || '';

      let filteredProducts = products.filter(product => {
        const matchesSearch = product.din.toLowerCase().includes(searchTerm) ||
                             product.productDescription.toLowerCase().includes(searchTerm) ||
                             product.manufacturer.toLowerCase().includes(searchTerm);
        const matchesCurrency = !filterCurrency || product.currency === filterCurrency;
        return matchesSearch && matchesCurrency;
      });

      if (sortBy) {
        filteredProducts.sort((a, b) => {
          if (sortBy === 'cost') return a.cost - b.cost;
          return a[sortBy].localeCompare(b[sortBy]);
        });
      }

      if (document.getElementById('productCount')) {
        document.getElementById('productCount').textContent = filteredProducts.length;
      }

      if (productList) {
        productList.innerHTML = '';
        filteredProducts.forEach(product => {
          const productDiv = document.createElement('div');
          productDiv.className = 'border p-4 rounded bg-gray-50 hover:bg-gray-100 transition-colors';
          productDiv.innerHTML = `
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2 text-sm">
              <div><strong>DIN:</strong> ${product.din}</div>
              <div><strong>Description:</strong> ${product.productDescription}</div>
              <div><strong>Manufacturer:</strong> ${product.manufacturer}</div>
              <div><strong>Form:</strong> ${product.form}</div>
              <div><strong>Strength:</strong> ${product.strength}</div>
              <div><strong>Size:</strong> ${product.size}</div>
              <div><strong>Cost:</strong> ${product.cost.toFixed(2)} ${product.currency}</div>
              <div><strong>SPC/Monograph:</strong> ${product.spcMonograph || 'N/A'}</div>
              <div>
                <button onclick="editProduct('${product.id}')" class="bg-yellow-500 text-white px-3 py-1 rounded text-sm hover:bg-yellow-600 mr-2">Edit</button>
                <button onclick="deleteProduct('${product.id}')" class="bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600">Delete</button>
              </div>
            </div>
          `;
          productList.appendChild(productDiv);
        });
      }
      // 2. 页面底部加一个隐藏的产品编辑表单
      if (!document.getElementById('editProductModal')) {
        const modal = document.createElement('div');
        modal.id = 'editProductModal';
        modal.style.display = 'none';
        modal.className = 'fixed inset-0 flex items-center justify-center bg-black bg-opacity-30 z-50';
        modal.innerHTML = `
          <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-lg relative">
            <button id="closeEditProductModal" class="absolute top-2 right-2 text-gray-500 hover:text-gray-800">&times;</button>
            <h3 class="text-lg font-semibold mb-4">Edit Product</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
              <input id="edit_din" class="border p-2 rounded w-full" placeholder="DIN">
              <input id="edit_productDescription" class="border p-2 rounded w-full" placeholder="Product Description">
              <input id="edit_manufacturer" class="border p-2 rounded w-full" placeholder="Manufacturer">
              <input id="edit_form" class="border p-2 rounded w-full" placeholder="Form">
              <input id="edit_strength" class="border p-2 rounded w-full" placeholder="Strength">
              <input id="edit_size" class="border p-2 rounded w-full" placeholder="Size">
              <input id="edit_cost" class="border p-2 rounded w-full" placeholder="Cost" type="number" step="0.01">
              <select id="edit_currency" class="border p-2 rounded w-full">
                <option value="USD">USD</option>
                <option value="CAD">CAD</option>
                <option value="EUR">EUR</option>
              </select>
              <input id="edit_spcMonograph" class="border p-2 rounded w-full" placeholder="SPC/Monograph">
            </div>
            <div class="mt-4 flex justify-end">
              <button id="saveEditProductBtn" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Save</button>
            </div>
          </div>
        `;
        document.body.appendChild(modal);
      }
    }

    function deleteProduct(id) {
      if (!currentUser) return;
      
      if (confirm('Are you sure you want to delete this product?')) {
        db.collection('products').doc(id).delete()
          .then(() => {
            loadProducts();
            alert('Product deleted successfully!');
          })
          .catch((error) => {
            alert('Error deleting product: ' + error.message);
          });
      }
    }

    // --- Real-time markup/price two-way binding ---
    function setupMarkupPriceBinding() {
      const markupInput = document.getElementById('markupInput');
      const priceInput = document.getElementById('itemPrice');
      const productInput = document.getElementById('productAutocomplete');
      // Remove previous listeners by cloning
      const markupClone = markupInput.cloneNode(true);
      markupInput.parentNode.replaceChild(markupClone, markupInput);
      const priceClone = priceInput.cloneNode(true);
      priceInput.parentNode.replaceChild(priceClone, priceInput);
      // Now markupClone and priceClone are the new elements
      let isUpdating = false;
      function getCost() {
        const productId = productInput.getAttribute('data-product-id');
        const product = products.find(p => p.id === productId);
        return product ? product.cost : 0;
      }
      markupClone.addEventListener('input', function () {
        if (isUpdating) return;
        isUpdating = true;
        const cost = parseFloat(getCost());
        const markup = parseFloat(markupClone.value);
        if (!isNaN(markup) && cost > 0) {
          const price = cost * (1 + markup / 100);
          priceClone.value = price.toFixed(2);
        }
        isUpdating = false;
      });
      priceClone.addEventListener('input', function () {
        if (isUpdating) return;
        isUpdating = true;
        const cost = parseFloat(getCost());
        const price = parseFloat(priceClone.value);
        if (!isNaN(price) && !isNaN(cost) && cost > 0) {
          if (price >= cost) {
            const markup = ((price - cost) / cost) * 100;
            markupClone.value = markup.toFixed(2);
          } else if (price === 0 || priceClone.value === '') {
            markupClone.value = '';
          } else {
            markupClone.value = '0.00';
          }
        } else {
          markupClone.value = '';
        }
        isUpdating = false;
      });
      // Update global references for later use
      markupClone.id = 'markupInput';
      priceClone.id = 'itemPrice';
    }

    // setupMarkupPriceBinding
    document.addEventListener('DOMContentLoaded', function() {
      setupMarkupPriceBinding();
    });

    // Call this after products are loaded and on product selection
    function updateProductSelect() {
      const productSelect = document.getElementById('productAutocomplete');
      productSelect.innerHTML = '';
      
      products.forEach(product => {
        const option = document.createElement('option');
        option.value = product.id;
        option.textContent = `${product.din} - ${product.productDescription} (${product.cost.toFixed(2)} ${product.currency})`;
        productSelect.appendChild(option);
      });

      // Add event listener for product selection
      productSelect.addEventListener('change', function() {
        const productId = this.value;
        if (productId) {
          const product = products.find(p => p.id === productId);
          if (product) {
            const suggestedPrice = product.cost * 1.15; // 15% markup

            document.getElementById('infoDescription').textContent = product.productDescription;
            document.getElementById('infoManufacturer').textContent = product.manufacturer;
            document.getElementById('infoForm').textContent = product.form;
            document.getElementById('infoStrength').textContent = product.strength;
            document.getElementById('infoSize').textContent = product.size;
            document.getElementById('infoCost').textContent = `$${product.cost.toFixed(2)}`;
            document.getElementById('selectedProductInfo').style.display = 'block';
            document.getElementById('quantity').value = '1';
            document.getElementById('markupInput').value = '15';
            document.getElementById('itemPrice').value = suggestedPrice.toFixed(2);
          }
        } else {
          document.getElementById('selectedProductInfo').style.display = 'none';
        }
      });
    }

    // --- Product Autocomplete for Quotation ---
    function setupProductAutocomplete() {
      const input = document.getElementById('productAutocomplete');
      const list = document.getElementById('productAutocompleteList');
      input.value = '';
      input.setAttribute('data-product-id', '');

      function renderList(filtered) {
        if (!filtered.length) {
          list.style.display = 'none';
          list.innerHTML = '';
          return;
        }
        list.innerHTML = filtered.map(p =>
          `<div class='px-3 py-2 cursor-pointer hover:bg-blue-100' data-id='${p.id}'>${p.din} - ${p.productDescription} (${p.manufacturer})</div>`
        ).join('');
        list.style.display = 'block';
      }

      input.addEventListener('input', function() {
        const keyword = input.value.trim().toLowerCase();
        if (!keyword) {
          renderList([]);
          return;
        }
        const filtered = products.filter(p =>
          p.productDescription.toLowerCase().includes(keyword) ||
          p.din.toLowerCase().includes(keyword) ||
          p.manufacturer.toLowerCase().includes(keyword)
        );
        renderList(filtered.slice(0, 20));
      });

      list.addEventListener('mousedown', function(e) {
        if (e.target && e.target.dataset.id) {
          const product = products.find(p => p.id === e.target.dataset.id);
          if (product) {
            input.value = `${product.din} - ${product.productDescription}`;
            input.setAttribute('data-product-id', product.id);
            list.style.display = 'none';
            // Fill product info and price/markup
            const suggestedPrice = product.cost * 1.15;
            document.getElementById('infoDescription').textContent = product.productDescription;
            document.getElementById('infoManufacturer').textContent = product.manufacturer;
            document.getElementById('infoForm').textContent = product.form;
            document.getElementById('infoStrength').textContent = product.strength;
            document.getElementById('infoSize').textContent = product.size;
            document.getElementById('infoCost').textContent = `$${product.cost.toFixed(2)}`;
            document.getElementById('selectedProductInfo').style.display = 'block';
            document.getElementById('quantity').value = '1';
            document.getElementById('markupInput').value = '15';
            document.getElementById('itemPrice').value = suggestedPrice.toFixed(2);
            setupMarkupPriceBinding();
          }
        }
      });

      // Hide list on blur (with delay for click)
      input.addEventListener('blur', function() {
        setTimeout(() => { list.style.display = 'none'; }, 200);
      });
    }

    // Customer management functions
    function addCustomer() {
      if (!currentUser) return;

      const customerName = document.getElementById('customerName').value;
      const contactPerson = document.getElementById('contactPerson').value;
      const email = document.getElementById('customerEmail').value;
      const phone = document.getElementById('phone').value;
      const address = document.getElementById('address').value;

      if (!customerName || !contactPerson || !email) {
        alert('Please fill in all required fields');
        return;
      }

      const customer = {
        customerName, contactPerson, email,
        phone: phone || '',
        address: address || '',
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      };

      db.collection('customers').add(customer)
        .then(() => {
          clearCustomerForm();
          loadCustomers();
          alert('Customer added successfully!');
        })
        .catch((error) => {
          alert('Error adding customer: ' + error.message);
        });
    }

    function clearCustomerForm() {
      ['customerName', 'contactPerson', 'customerEmail', 'phone', 'address'].forEach(id => {
        document.getElementById(id).value = '';
      });
    }

    function loadCustomers() {
      if (!currentUser) return;

      db.collection('customers').orderBy('createdAt', 'desc').get()
        .then((querySnapshot) => {
          customers = [];
          querySnapshot.forEach((doc) => {
            customers.push({ id: doc.id, ...doc.data() });
          });
          displayCustomers();
          updateCustomerSelect();
        })
        .catch((error) => {
          alert('Error loading customers: ' + error.message);
        });
    }

    function displayCustomers() {
      const customerList = document.getElementById('customerList');
      const searchTerm = document.getElementById('customerSearch')?.value.toLowerCase() || '';

      let filteredCustomers = customers.filter(customer => {
        return customer.customerName.toLowerCase().includes(searchTerm) ||
               customer.email.toLowerCase().includes(searchTerm) ||
               customer.phone.toLowerCase().includes(searchTerm);
      });

      if (document.getElementById('customerCount')) {
        document.getElementById('customerCount').textContent = filteredCustomers.length;
      }

      if (customerList) {
        customerList.innerHTML = '';
        filteredCustomers.forEach(customer => {
          const customerDiv = document.createElement('div');
          customerDiv.className = 'border p-4 rounded bg-gray-50 hover:bg-gray-100 transition-colors';
          customerDiv.innerHTML = `
            <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-sm">
              <div><strong>Name:</strong> ${customer.customerName}</div>
              <div><strong>Contact:</strong> ${customer.contactPerson}</div>
              <div><strong>Email:</strong> ${customer.email}</div>
              <div><strong>Phone:</strong> ${customer.phone}</div>
              <div class="md:col-span-2"><strong>Address:</strong> ${customer.address}</div>
              <div>
                <button onclick="deleteCustomer('${customer.id}')" class="bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600">Delete</button>
              </div>
            </div>
          `;
          customerList.appendChild(customerDiv);
        });
      }
    }

    function deleteCustomer(id) {
      if (!currentUser) return;
      
      if (confirm('Are you sure you want to delete this customer?')) {
        db.collection('customers').doc(id).delete()
          .then(() => {
            loadCustomers();
            alert('Customer deleted successfully!');
          })
          .catch((error) => {
            alert('Error deleting customer: ' + error.message);
          });
      }
    }

    function updateCustomerSelect() {
      const customerSelect = document.getElementById('customerSelect');
      customerSelect.innerHTML = '<option value="">Select Customer</option>';
      
      customers.forEach(customer => {
        const option = document.createElement('option');
        option.value = customer.id;
        option.textContent = customer.customerName;
        customerSelect.appendChild(option);
      });
    }

    // Quotation management functions
    function addToQuotation() {
      const input = document.getElementById('productAutocomplete');
      const productId = input.getAttribute('data-product-id');
      const quantity = parseInt(document.getElementById('quantity').value) || 1;
      const markup = parseFloat(document.getElementById('markupInput').value);
      const priceInput = parseFloat(document.getElementById('itemPrice').value);
      if (!productId) {
        alert('Please select a product');
        return;
      }
      const product = products.find(p => p.id === productId);
      if (!product) {
        alert('Product not found');
        return;
      }
      let finalPrice = 0;
      let finalMarkup = 0;
      let markupAmount = 0;
      const baseCost = product.cost;
      if (!isNaN(priceInput) && priceInput > 0) {
        if (priceInput < baseCost) {
          alert(`Price cannot be below the base cost of $${baseCost.toFixed(2)}`);
          return;
        }
        finalPrice = priceInput;
        markupAmount = finalPrice - baseCost;
        finalMarkup = (markupAmount / baseCost) * 100;
      } else if (!isNaN(markup) && markup > 0) {
        finalMarkup = markup;
        finalPrice = baseCost * (1 + markup / 100);
        markupAmount = finalPrice - baseCost;
      } else {
        alert('Please enter a valid price or markup %');
        return;
      }
      const totalPrice = finalPrice * quantity;
      const quotationItem = {
        productId: productId,
        product: product,
        quantity: quantity,
        baseCost: baseCost,
        markup: finalMarkup,
        markupAmount: markupAmount,
        finalPrice: finalPrice,
        totalPrice: totalPrice,
        currency: product.currency,
        productDescription: product.productDescription,
        manufacturer: product.manufacturer,
        form: product.form,
        strength: product.strength,
        size: product.size,
        spcMonograph: product.spcMonograph
      };
      currentQuotation.push(quotationItem);
      displayQuotationItems();
      clearProductSelection();
    }

    function displayQuotationItems() {
      const quotationItems = document.getElementById('quotationItems');
      quotationItems.innerHTML = '';

      // Table header
      const headerDiv = document.createElement('div');
      headerDiv.className = 'grid grid-cols-8 gap-2 font-semibold text-sm bg-gray-200 p-2 rounded';
      headerDiv.innerHTML = `
        <div>Description</div>
        <div>Manufacturer</div>
        <div>Form</div>
        <div>Strength</div>
        <div>Size</div>
        <div>Cost</div>
        <div>Markup %</div>
        <div>Price</div>
      `;
      quotationItems.appendChild(headerDiv);

      currentQuotation.forEach((item, index) => {
        const itemDiv = document.createElement('div');
        itemDiv.className = 'grid grid-cols-8 gap-2 items-center border-b p-2';
        itemDiv.innerHTML = `
          <div>${item.productDescription}</div>
          <div>${item.manufacturer}</div>
          <div>${item.form}</div>
          <div>${item.strength}</div>
          <div>${item.size}</div>
          <div>$${item.baseCost.toFixed(2)} ${item.currency}</div>
          <div>${item.markup.toFixed(1)}</div>
          <div>$${item.finalPrice.toFixed(2)} ${item.currency}</div>
        `;
        quotationItems.appendChild(itemDiv);
      });

      updateQuotationTotals();
    }

    function updateQuotationTotals() {
      const total = currentQuotation.reduce((sum, item) => sum + item.totalPrice, 0);
      document.getElementById('quotationTotal').textContent = total.toFixed(2);
    }

    function clearProductSelection() {
      document.getElementById('productAutocomplete').value = '';
      document.getElementById('productAutocomplete').setAttribute('data-product-id', '');
      document.getElementById('quantity').value = '1';
      document.getElementById('markupInput').value = '15';
      document.getElementById('itemPrice').value = 0;
      document.getElementById('selectedProductInfo').style.display = 'none';
    }

    function clearQuotation() {
      currentQuotation = [];
      displayQuotationItems();
      clearProductSelection();
    }

    function saveQuotation() {
      if (!currentUser) return;

      const customerId = document.getElementById('customerSelect').value;
      let quotationDate = document.getElementById('quotationDate').value;
      if (!quotationDate) {
        const today = new Date();
        quotationDate = today.toISOString().slice(0, 10);
        document.getElementById('quotationDate').value = quotationDate;
      }

      if (!customerId) {
        alert('Please select a customer');
        return;
      }

      if (currentQuotation.length === 0) {
        alert('Please add at least one product to the quotation');
        return;
      }

      const customer = customers.find(c => c.id === customerId);
      const total = currentQuotation.reduce((sum, item) => sum + item.totalPrice, 0);

      const quotation = {
        customerId: customerId,
        customerName: customer.customerName,
        quotationDate: quotationDate,
        items: currentQuotation,
        total: total,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      };

      db.collection('quotations').add(quotation)
        .then(() => {
          alert('Quotation saved successfully!');
          clearQuotation();
          loadQuotationHistory();
        })
        .catch((error) => {
          alert('Error saving quotation: ' + error.message);
        });
    }

    function copyQuotationToClipboard() {
      if (currentQuotation.length === 0) {
        alert('No items to copy');
        return;
      }
      const customerId = document.getElementById('customerSelect').value;
      const customer = customers.find(c => c.id === customerId);
      let quotationDate = document.getElementById('quotationDate').value;
      if (!quotationDate) {
        const today = new Date();
        quotationDate = today.toISOString().slice(0, 10);
      }

      let text = '';
      text += `Customer: | ${customer ? customer.customerName : ''}\n`;
      text += `Date: | ${quotationDate}\n\n`;
      currentQuotation.forEach(item => {
        text += `DIN - ${item.product.din}\n`;
        text += `Product description - ${item.productDescription}\n`;
        text += `Manufacturer - ${item.manufacturer}\n`;
        text += `Form - ${item.form}\n`;
        text += `Strength - ${item.strength}\n`;
        text += `Size - ${item.size}\n`;
        text += `Price - ${item.finalPrice.toFixed(2)} ${item.currency}\n`;
        text += `SPC/Monograph - ${item.spcMonograph || ''}\n\n`;
      });

      const tempTextArea = document.createElement('textarea');
      tempTextArea.value = text;
      document.body.appendChild(tempTextArea);
      tempTextArea.select();
      document.execCommand('copy');
      document.body.removeChild(tempTextArea);
      alert('Quotation copied to clipboard!');
    }

    // Quotation history functions
    function loadQuotationHistory() {
      if (!currentUser) return;

      db.collection('quotations').orderBy('createdAt', 'desc').get()
        .then((querySnapshot) => {
          quotations = [];
          querySnapshot.forEach((doc) => {
            quotations.push({ id: doc.id, ...doc.data() });
          });
          displayQuotationHistory();
        })
        .catch((error) => {
          alert('Error loading quotation history: ' + error.message);
        });
    }

    function displayQuotationHistory() {
      const historyList = document.getElementById('historyList');
      const searchTerm = document.getElementById('historySearch')?.value.toLowerCase() || '';
      const dateFilter = document.getElementById('historyDateFilter')?.value || '';

      let filteredQuotations = quotations.filter(quotation => {
        // Support product-related field search
        const matchesProduct = (quotation.items || []).some(item => {
          const prod = item.product || {};
          return (
            (prod.din || '').toLowerCase().includes(searchTerm) ||
            (prod.productDescription || '').toLowerCase().includes(searchTerm) ||
            (prod.manufacturer || '').toLowerCase().includes(searchTerm)
          );
        });
        const matchesCustomer = (quotation.customerName || '').toLowerCase().includes(searchTerm);
        const matchesId = (quotation.id || '').toLowerCase().includes(searchTerm);

        let matchesDate = true;
        if (dateFilter) {
          const quotationDate = new Date(quotation.quotationDate);
          const today = new Date();
          switch (dateFilter) {
            case 'today':
              matchesDate = quotationDate.toDateString() === today.toDateString();
              break;
            case 'week':
              const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
              matchesDate = quotationDate >= weekAgo;
              break;
            case 'month':
              const monthAgo = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000);
              matchesDate = quotationDate >= monthAgo;
              break;
          }
        }
        // One match
        return (matchesCustomer || matchesId || matchesProduct) && matchesDate;
      });

      if (historyList) {
        historyList.innerHTML = '';
        filteredQuotations.forEach(quotation => {
          const itemsCount = Array.isArray(quotation.items) ? quotation.items.length : 0;
          const totalValue = typeof quotation.total === 'number' ? quotation.total.toFixed(2) : '0.00';
          const customerName = quotation.customerName || '';
          const quotationDate = quotation.quotationDate || '';
          //product details
          let itemsDetail = '';
          if (Array.isArray(quotation.items)) {
            itemsDetail = '<ul class="ml-4 list-disc text-xs text-gray-700">' + quotation.items.map(item =>
              `<li>${item.product.din || ''} ${item.product.productDescription || ''} ($${item.finalPrice ? item.finalPrice.toFixed(2) : ''} ${item.currency || ''})</li>`
            ).join('') + '</ul>';
          }
          historyList.innerHTML += `
            <div class="border p-4 rounded bg-gray-50 hover:bg-gray-100 transition-colors">
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                  <div class="font-semibold">${customerName}</div>
                  <div class="text-sm text-gray-600">Date: ${quotationDate}</div>
                  <div class="text-sm text-gray-600">Items: ${itemsCount}</div>
                  ${itemsDetail}
                </div>
                <div class="text-center">
                  <div class="text-sm text-gray-600">Total</div>
                  <div class="font-semibold text-blue-600">${totalValue}</div>
                </div>
                <div class="text-center flex flex-col gap-2 items-center">
                  <button onclick="viewQuotationDetails('${quotation.id}')" class="bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600 mb-1">View Details</button>
                  <button onclick="copyHistoryQuotationToClipboard('${quotation.id}')" class="bg-purple-600 text-white px-3 py-1 rounded text-sm hover:bg-purple-700">Copy to Clipboard</button>
                </div>
              </div>
            </div>
          `;
        });
      }
    }

    function viewQuotationDetails(quotationId) {
      const quotation = quotations.find(q => q.id === quotationId);
      if (!quotation) return;

      const detailsWindow = window.open('', '_blank');
      detailsWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
          <title>Quotation Details</title>
          <style>
            body { font-family: Arial, sans-serif; margin: 20px; }
            .header { text-align: center; margin-bottom: 30px; }
            .customer-info { margin-bottom: 20px; }
            table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
            th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
            th { background-color: #f2f2f2; }
            .totals { text-align: right; margin-top: 20px; }
            .total { font-size: 18px; font-weight: bold; }
          </style>
        </head>
        <body>
          <div class="header">
            <h1>Quotation Details</h1>
            <p>Date: ${quotation.quotationDate}</p>
          </div>
          
          <div class="customer-info">
            <h3>Customer Information</h3>
            <p><strong>Name:</strong> ${quotation.customerName}</p>
          </div>

          <table>
            <thead>
              <tr>
                <th>Product</th>
                <th>Description</th>
                <th>Qty</th>
                <th>Base Cost</th>
                <th>Markup</th>
                <th>Final Price</th>
                <th>Total</th>
              </tr>
            </thead>
            <tbody>
              ${quotation.items.map(item => `
                <tr>
                  <td>${item.product.din}</td>
                  <td>${item.product.productDescription}</td>
                  <td>${item.quantity}</td>
                  <td>${item.baseCost.toFixed(2)} ${item.currency}</td>
                  <td>${item.markup.toFixed(1)}%</td>
                  <td>${item.finalPrice.toFixed(2)} ${item.currency}</td>
                  <td>${item.totalPrice.toFixed(2)} ${item.currency}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>

          <div class="totals">
            <p class="total">Total: ${quotation.total.toFixed(2)}</p>
          </div>
        </body>
        </html>
      `);
      detailsWindow.document.close();
    }

    // Bulk upload functions
    function uploadFile() {
      const fileInput = document.getElementById('fileInput');
      const file = fileInput.files[0];
      
      if (!file) {
        alert('Please select a file');
        return;
      }

      const reader = new FileReader();
      reader.onload = function(e) {
        const data = e.target.result;
        
        if (file.name.endsWith('.csv')) {
          Papa.parse(data, {
            header: true,
            complete: function(results) {
              processBulkData(results.data);
            },
            error: function(error) {
              alert('Error parsing CSV file: ' + error.message);
            }
          });
        } else if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
          const workbook = XLSX.read(data, { type: 'binary' });
          const sheetName = workbook.SheetNames[0];
          const worksheet = workbook.Sheets[sheetName];
          const jsonData = XLSX.utils.sheet_to_json(worksheet);
          processBulkData(jsonData);
        }
      };
      
      reader.readAsBinaryString(file);
    }

    function processBulkData(data) {
      if (!currentUser) return;

      let successCount = 0;
      let errorCount = 0;
      const promises = [];

      // Map normalized keys to standard field names
      const fieldMap = {
        din: 'DIN',
        productdescription: 'Product Description',
        manufacturer: 'Manufacturer',
        form: 'Form',
        strength: 'Strength',
        size: 'Size',
        cost: 'Cost',
        currency: 'Currency',
        spcmonograph: 'SPC/Monograph'
      };

      function normalizeKey(key) {
        return key.trim().toLowerCase().replace(/\s+/g, '');
      }

      function normalizeRow(row) {
        const normalized = {};
        for (const key in row) {
          if (Object.hasOwnProperty.call(row, key)) {
            const nkey = normalizeKey(key);
            let value = row[key];
            if (typeof value === 'string') value = value.trim();
            // Map to standard field name if possible
            if (fieldMap[nkey]) {
              normalized[fieldMap[nkey]] = value;
            } else {
              normalized[key.trim()] = value;
            }
          }
        }
        return normalized;
      }

      data.forEach((row, index) => {
        const nrow = normalizeRow(row);
        if (index === 0) {
          console.log('Parsed header keys:', Object.keys(nrow));
        }
        // Required fields
        const required = [
          nrow['DIN'],
          nrow['Product Description'],
          nrow['Manufacturer'],
          nrow['Form'],
          nrow['Strength'],
          nrow['Size'],
          nrow['Cost']
        ];
        if (required.every(v => v !== undefined && v !== null && v !== '')) {
          const product = {
            din: nrow['DIN'].toString(),
            productDescription: nrow['Product Description'],
            manufacturer: nrow['Manufacturer'],
            form: nrow['Form'],
            strength: nrow['Strength'],
            size: nrow['Size'],
            cost: parseFloat(nrow['Cost']) || 0,
            currency: nrow['Currency'] || 'USD',
            spcMonograph: nrow['SPC/Monograph'] || '',
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          };
          promises.push(
            db.collection('products').add(product)
              .then(() => successCount++)
              .catch((e) => { errorCount++; console.error('Upload error:', e, product); })
          );
        } else {
          errorCount++;
          console.warn('Skipped row (missing required fields):', nrow);
        }
      });

      Promise.all(promises).then(() => {
        alert(`Bulk upload completed!\nSuccess: ${successCount}\nErrors: ${errorCount}`);
        loadProducts();
        document.getElementById('fileInput').value = '';
      });
    }

    // Search and filter functions
    function clearSearch() {
      document.getElementById('searchInput').value = '';
      document.getElementById('sortBy').value = '';
      document.getElementById('filterCurrency').value = '';
      displayProducts();
    }

    function clearCustomerSearch() {
      document.getElementById('customerSearch').value = '';
      displayCustomers();
    }

    function exportToCSV() {
      const searchTerm = document.getElementById('searchInput')?.value.toLowerCase() || '';
      const filterCurrency = document.getElementById('filterCurrency')?.value || '';

      let filteredProducts = products.filter(product => {
        const matchesSearch = product.din.toLowerCase().includes(searchTerm) ||
                             product.productDescription.toLowerCase().includes(searchTerm) ||
                             product.manufacturer.toLowerCase().includes(searchTerm);
        const matchesCurrency = !filterCurrency || product.currency === filterCurrency;
        return matchesSearch && matchesCurrency;
      });

      const csvContent = [
        ['DIN', 'Product Description', 'Manufacturer', 'Form', 'Strength', 'Size', 'Cost', 'Currency', 'SPC/Monograph'],
        ...filteredProducts.map(product => [
          product.din,
          product.productDescription,
          product.manufacturer,
          product.form,
          product.strength,
          product.size,
          product.cost,
          product.currency,
          product.spcMonograph
        ])
      ].map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');

      const blob = new Blob([csvContent], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'products_export.csv';
      a.click();
      window.URL.revokeObjectURL(url);
    }

    // Add event listeners for search functionality
    document.addEventListener('DOMContentLoaded', function() {
      // Product search
      const searchInput = document.getElementById('searchInput');
      if (searchInput) {
        searchInput.addEventListener('input', displayProducts);
      }

      const sortBy = document.getElementById('sortBy');
      if (sortBy) {
        sortBy.addEventListener('change', displayProducts);
      }

      const filterCurrency = document.getElementById('filterCurrency');
      if (filterCurrency) {
        filterCurrency.addEventListener('change', displayProducts);
      }

      // Customer search
      const customerSearch = document.getElementById('customerSearch');
      if (customerSearch) {
        customerSearch.addEventListener('input', displayCustomers);
      }

      // Quotation history search
      const historySearch = document.getElementById('historySearch');
      if (historySearch) {
        historySearch.addEventListener('input', displayQuotationHistory);
      }

      const historyDateFilter = document.getElementById('historyDateFilter');
      if (historyDateFilter) {
        historyDateFilter.addEventListener('change', displayQuotationHistory);
      }
    });

    // editProduct
    let editingProductId = null;
    window.editProduct = function(id) {
      const product = products.find(p => p.id === id);
      if (!product) return;
      editingProductId = id;
      document.getElementById('edit_din').value = product.din;
      document.getElementById('edit_productDescription').value = product.productDescription;
      document.getElementById('edit_manufacturer').value = product.manufacturer;
      document.getElementById('edit_form').value = product.form;
      document.getElementById('edit_strength').value = product.strength;
      document.getElementById('edit_size').value = product.size;
      document.getElementById('edit_cost').value = product.cost;
      document.getElementById('edit_currency').value = product.currency;
      document.getElementById('edit_spcMonograph').value = product.spcMonograph;
      document.getElementById('editProductModal').style.display = 'flex';
    }
    document.getElementById('closeEditProductModal').onclick = function() {
      document.getElementById('editProductModal').style.display = 'none';
      editingProductId = null;
    }
    document.getElementById('saveEditProductBtn').onclick = function() {
      if (!editingProductId) return;
      const updated = {
        din: document.getElementById('edit_din').value,
        productDescription: document.getElementById('edit_productDescription').value,
        manufacturer: document.getElementById('edit_manufacturer').value,
        form: document.getElementById('edit_form').value,
        strength: document.getElementById('edit_strength').value,
        size: document.getElementById('edit_size').value,
        cost: parseFloat(document.getElementById('edit_cost').value),
        currency: document.getElementById('edit_currency').value,
        spcMonograph: document.getElementById('edit_spcMonograph').value
      };
      db.collection('products').doc(editingProductId).update(updated)
        .then(() => {
          document.getElementById('editProductModal').style.display = 'none';
          editingProductId = null;
          loadProducts();
          alert('Product updated successfully!');
        })
        .catch((error) => {
          alert('Error updating product: ' + error.message);
        });
    }

    // copyHistoryQuotationToClipboard 
    window.copyHistoryQuotationToClipboard = function(quotationId) {
      const quotation = quotations.find(q => q.id === quotationId);
      if (!quotation) return;
      let text = '';
      text += `Customer: | ${quotation.customerName || ''}\n`;
      let quotationDate = quotation.quotationDate || '';
      if (!quotationDate) {
        const today = new Date();
        quotationDate = today.toISOString().slice(0, 10);
      }
      text += `Date: | ${quotationDate}\n\n`;
      (quotation.items || []).forEach(item => {
        text += `DIN - ${item.product?.din || ''}\n`;
        text += `Product description - ${item.productDescription || ''}\n`;
        text += `Manufacturer - ${item.manufacturer || ''}\n`;
        text += `Form - ${item.form || ''}\n`;
        text += `Strength - ${item.strength || ''}\n`;
        text += `Size - ${item.size || ''}\n`;
        text += `Price - ${item.finalPrice?.toFixed(2) || ''} ${item.currency || ''}\n`;
        text += `SPC/Monograph - ${item.spcMonograph || ''}\n\n`;
      });
      const tempTextArea = document.createElement('textarea');
      tempTextArea.value = text;
      document.body.appendChild(tempTextArea);
      tempTextArea.select();
      document.execCommand('copy');
      document.body.removeChild(tempTextArea);
      alert('Quotation copied to clipboard!');
    }
  </script>
</body>
</html>